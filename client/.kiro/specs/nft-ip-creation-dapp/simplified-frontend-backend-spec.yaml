spec_name: "Story Foundation dApp - Frontend/Backend Integration"
version: "1.0.0"
description: "Simplified spec for Story Protocol dApp with atomic NFT creation and IP registration"

story_protocol_integration:
  repository: "https://github.com/PIP-Labs-RE/story-protocol-boilerplate"
  documentation: "https://story.foundation/docs"
  core_contract: "StoryProtocolCore"
  key_functions:
    - "createAndRegisterIP"
    - "registerIP"
    - "mintNFT"

frontend:
  technology_stack:
    - "React/Next.js"
    - "TypeScript"
    - "Wagmi/Viem (Web3 integration)"
    - "TailwindCSS/DaisyUI"
  
  function_calls:
    create_nft_ip:
      function: "createAndRegisterIP"
      parameters:
        metadata:
          type: "object"
          properties:
            title: "string"
            description: "string"
            image: "File"
            attributes: "array"
            royalty_percentage: "number"
            royalty_recipient: "string"
        creator_wallet: "string"
        signature: "string"
      
      implementation:
        ```typescript
        const createNFTIP = async (metadata: NFTMetadata) => {
          setStatus('loading');
          try {
            const response = await fetch('/api/nft/create', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                metadata,
                creator_wallet: account,
                signature: await signMessage()
              })
            });
            
            const result = await response.json();
            if (result.success) {
              setStatus('success');
              setTransactionResult(result.data);
            } else {
              throw new Error(result.error.message);
            }
          } catch (error) {
            setStatus('error');
            setError(error.message);
          }
        };
        ```
  
  ui_states:
    idle:
      form_enabled: true
      submit_button_text: "Create NFT & Register IP"
      loading_indicator: false
      error_message: null
    
    loading:
      form_enabled: false
      submit_button_text: "Creating NFT/IP..."
      loading_indicator: true
      progress_steps:
        - "Uploading to IPFS"
        - "Submitting transaction"
        - "Waiting for confirmation"
      estimated_time: "2-3 minutes"
    
    success:
      form_enabled: false
      display_result: true
      result_data:
        - "Transaction Hash"
        - "NFT ID"
        - "IP ID"
        - "Metadata URI"
      actions:
        - "View on Explorer"
        - "Create Another"
        - "Go to Portfolio"
    
    error:
      form_enabled: true
      error_display: true
      retry_button: true
      error_types:
        - "Wallet connection failed"
        - "Transaction rejected"
        - "Insufficient funds"
        - "Network error"
  
  display_logic:
    nft_ip_data:
      components:
        - "NFTCard"
        - "IPDetails"
        - "OwnershipInfo"
        - "RoyaltyDisplay"
      
      data_binding:
        ```typescript
        interface NFTIPDisplay {
          nft: {
            id: string;
            title: string;
            description: string;
            image_url: string;
            attributes: Attribute[];
          };
          ip: {
            id: string;
            owner: string;
            registration_date: string;
            royalty_percentage: number;
            royalty_recipient: string;
          };
          transaction: {
            hash: string;
            block_number: number;
            timestamp: string;
          };
        }
        ```
      
      rendering_logic:
        - "Load metadata from IPFS/cache"
        - "Display image with fallback"
        - "Format dates and numbers"
        - "Show ownership verification"
        - "Display royalty information"

backend:
  technology_stack:
    - "Node.js/Express"
    - "TypeScript"
    - "PostgreSQL/Prisma"
    - "Story Protocol SDK"
    - "IPFS (Pinata/NFT.Storage)"
  
  api_endpoints:
    create_nft_ip:
      endpoint: "POST /api/nft/create"
      middleware:
        - "validateRequest"
        - "verifyWallet"
        - "rateLimiter"
      
      handler:
        ```typescript
        export async function POST(request: Request) {
          try {
            const { metadata, creator_wallet, signature } = await request.json();
            
            // Validate input
            const validation = validateNFTMetadata(metadata);
            if (!validation.valid) {
              return Response.json({ 
                success: false, 
                error: { code: 'VALIDATION_ERROR', message: validation.error }
              }, { status: 400 });
            }
            
            // Verify wallet signature
            const isValidSignature = await verifySignature(creator_wallet, signature);
            if (!isValidSignature) {
              return Response.json({ 
                success: false, 
                error: { code: 'INVALID_SIGNATURE', message: 'Invalid wallet signature' }
              }, { status: 401 });
            }
            
            // Upload to IPFS
            const imageUri = await uploadToIPFS(metadata.image);
            const metadataUri = await uploadToIPFS({
              ...metadata,
              image: imageUri
            });
            
            // Call Story Protocol
            const result = await storyProtocolService.createAndRegisterIP({
              metadataUri,
              royaltyPercentage: metadata.royalty_percentage * 100, // Convert to basis points
              royaltyRecipient: metadata.royalty_recipient || creator_wallet
            });
            
            // Store in database
            await prisma.nftIp.create({
              data: {
                nftId: result.nftId,
                ipId: result.ipId,
                metadataUri,
                creatorWallet: creator_wallet,
                royaltyPercentage: metadata.royalty_percentage,
                royaltyRecipient: metadata.royalty_recipient || creator_wallet,
                transactionHash: result.transactionHash,
                blockNumber: result.blockNumber
              }
            });
            
            return Response.json({
              success: true,
              data: {
                transaction_hash: result.transactionHash,
                nft_id: result.nftId,
                ip_id: result.ipId,
                metadata_uri: metadataUri,
                block_number: result.blockNumber
              }
            });
            
          } catch (error) {
            console.error('NFT/IP creation failed:', error);
            return Response.json({
              success: false,
              error: {
                code: 'CREATION_FAILED',
                message: error.message
              }
            }, { status: 500 });
          }
        }
        ```
    
    get_user_nfts:
      endpoint: "GET /api/user/{wallet}/nfts"
      parameters:
        - "wallet: string (path)"
        - "page: number (query)"
        - "limit: number (query)"
        - "search: string (query)"
      
      response:
        ```json
        {
          "success": true,
          "data": {
            "items": [
              {
                "nft_id": "1",
                "ip_id": "0xabc...",
                "title": "Digital Art",
                "description": "...",
                "image_url": "https://ipfs.io/ipfs/...",
                "creator_wallet": "0x742...",
                "royalty_percentage": 7.5,
                "transaction_hash": "0x123...",
                "created_at": "2024-01-15T10:30:00Z"
              }
            ],
            "pagination": {
              "current_page": 1,
              "total_pages": 5,
              "total_items": 87,
              "has_next": true
            }
          }
        }
        ```
    
    get_nft_details:
      endpoint: "GET /api/nft/{id}"
      parameters:
        - "id: string (path)"
      
      response:
        ```json
        {
          "success": true,
          "data": {
            "nft": {
              "id": "1",
              "title": "Digital Art Masterpiece",
              "description": "A unique digital artwork...",
              "image_url": "https://ipfs.io/ipfs/QmYwAPJzv5CZsnA625s3Xf2nemtYgPpHdWEz79ojWnPbdG",
              "attributes": [
                {"trait_type": "Style", "value": "Abstract"},
                {"trait_type": "Rarity", "value": "Legendary"}
              ]
            },
            "ip": {
              "id": "0xabcdef1234567890abcdef1234567890abcdef12",
              "owner": "0x742d35Cc6634C0532925a3b8D4C9db96590c6C87",
              "registration_date": "2024-01-15T10:30:00Z",
              "royalty_percentage": 7.5,
              "royalty_recipient": "0x742d35Cc6634C0532925a3b8D4C9db96590c6C87"
            },
            "transaction": {
              "hash": "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef",
              "block_number": 18500000,
              "timestamp": "2024-01-15T10:30:00Z"
            }
          }
        }
        ```
  
  database_schema:
    nft_ips_table:
      ```sql
      CREATE TABLE nft_ips (
        id SERIAL PRIMARY KEY,
        nft_id VARCHAR(78) UNIQUE NOT NULL,
        ip_id VARCHAR(42) UNIQUE NOT NULL,
        metadata_uri TEXT NOT NULL,
        creator_wallet VARCHAR(42) NOT NULL,
        royalty_percentage DECIMAL(5,2) NOT NULL,
        royalty_recipient VARCHAR(42) NOT NULL,
        transaction_hash VARCHAR(66) NOT NULL,
        block_number BIGINT NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        
        INDEX idx_creator_wallet (creator_wallet),
        INDEX idx_transaction_hash (transaction_hash),
        INDEX idx_created_at (created_at)
      );
      ```
    
    metadata_cache_table:
      ```sql
      CREATE TABLE metadata_cache (
        id SERIAL PRIMARY KEY,
        uri TEXT UNIQUE NOT NULL,
        metadata JSONB NOT NULL,
        cached_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        expires_at TIMESTAMP,
        
        INDEX idx_uri (uri),
        INDEX idx_expires_at (expires_at)
      );
      ```
    
    event_logs_table:
      ```sql
      CREATE TABLE event_logs (
        id SERIAL PRIMARY KEY,
        event_type VARCHAR(50) NOT NULL,
        contract_address VARCHAR(42) NOT NULL,
        transaction_hash VARCHAR(66) NOT NULL,
        block_number BIGINT NOT NULL,
        log_index INTEGER NOT NULL,
        event_data JSONB NOT NULL,
        processed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        status VARCHAR(20) DEFAULT 'processed',
        
        UNIQUE KEY unique_event (transaction_hash, log_index),
        INDEX idx_event_type (event_type),
        INDEX idx_block_number (block_number)
      );
      ```
  
  event_listeners:
    story_protocol_events:
      contract: "StoryProtocolCore"
      events:
        ip_registered:
          event_name: "IPRegistered"
          handler: "handleIPRegistered"
          data_mapping:
            ```typescript
            async function handleIPRegistered(event: IPRegisteredEvent) {
              const { ipId, owner, metadataURI, royaltyPercentage } = event.args;
              
              await prisma.nftIp.upsert({
                where: { ipId },
                update: {
                  metadataUri: metadataURI,
                  royaltyPercentage: royaltyPercentage / 100, // Convert from basis points
                  updatedAt: new Date()
                },
                create: {
                  ipId,
                  creatorWallet: owner,
                  metadataUri: metadataURI,
                  royaltyPercentage: royaltyPercentage / 100,
                  transactionHash: event.transactionHash,
                  blockNumber: event.blockNumber
                }
              });
              
              // Log the event
              await prisma.eventLog.create({
                data: {
                  eventType: 'IPRegistered',
                  contractAddress: event.address,
                  transactionHash: event.transactionHash,
                  blockNumber: event.blockNumber,
                  logIndex: event.logIndex,
                  eventData: event.args,
                  status: 'processed'
                }
              });
            }
            ```
        
        nft_minted:
          event_name: "NFTMinted"
          handler: "handleNFTMinted"
          data_mapping:
            ```typescript
            async function handleNFTMinted(event: NFTMintedEvent) {
              const { tokenId, to, tokenURI } = event.args;
              
              await prisma.nftIp.update({
                where: { 
                  creatorWallet: to,
                  transactionHash: event.transactionHash
                },
                data: {
                  nftId: tokenId.toString(),
                  metadataUri: tokenURI
                }
              });
            }
            ```

transaction_flow:
  atomic_nft_ip_creation:
    step_1:
      description: "Frontend form submission"
      data:
        ```json
        {
          "metadata": {
            "title": "Digital Art Masterpiece",
            "description": "A unique digital artwork representing the fusion of technology and creativity",
            "image": "File object",
            "attributes": [
              {"trait_type": "Style", "value": "Abstract"},
              {"trait_type": "Medium", "value": "Digital"},
              {"trait_type": "Rarity", "value": "Legendary"}
            ],
            "royalty_percentage": 7.5,
            "royalty_recipient": "0x742d35Cc6634C0532925a3b8D4C9db96590c6C87"
          },
          "creator_wallet": "0x742d35Cc6634C0532925a3b8D4C9db96590c6C87",
          "signature": "0x..."
        }
        ```
    
    step_2:
      description: "Backend validation and IPFS upload"
      actions:
        - "Validate metadata structure"
        - "Verify wallet signature"
        - "Upload image to IPFS"
        - "Create and upload metadata JSON"
      
      ipfs_metadata:
        ```json
        {
          "name": "Digital Art Masterpiece",
          "description": "A unique digital artwork representing the fusion of technology and creativity",
          "image": "ipfs://QmYwAPJzv5CZsnA625s3Xf2nemtYgPpHdWEz79ojWnPbdG",
          "attributes": [
            {"trait_type": "Style", "value": "Abstract"},
            {"trait_type": "Medium", "value": "Digital"},
            {"trait_type": "Rarity", "value": "Legendary"}
          ],
          "external_url": "https://example.com/nft/1"
        }
        ```
    
    step_3:
      description: "Story Protocol contract interaction"
      contract_call:
        function: "createAndRegisterIP"
        parameters:
          - "metadataURI: ipfs://QmMetadataHash..."
          - "royaltyPercentage: 750 (7.5% in basis points)"
          - "royaltyRecipient: 0x742d35Cc6634C0532925a3b8D4C9db96590c6C87"
      
      transaction_result:
        ```json
        {
          "transactionHash": "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef",
          "blockNumber": 18500000,
          "gasUsed": 250000,
          "events": [
            {
              "event": "NFTMinted",
              "args": {
                "tokenId": "1",
                "to": "0x742d35Cc6634C0532925a3b8D4C9db96590c6C87",
                "tokenURI": "ipfs://QmMetadataHash..."
              }
            },
            {
              "event": "IPRegistered",
              "args": {
                "ipId": "0xabcdef1234567890abcdef1234567890abcdef12",
                "owner": "0x742d35Cc6634C0532925a3b8D4C9db96590c6C87",
                "metadataURI": "ipfs://QmMetadataHash...",
                "royaltyPercentage": 750
              }
            }
          ]
        }
        ```
    
    step_4:
      description: "Database storage and response"
      database_record:
        ```json
        {
          "nft_id": "1",
          "ip_id": "0xabcdef1234567890abcdef1234567890abcdef12",
          "metadata_uri": "ipfs://QmMetadataHash...",
          "creator_wallet": "0x742d35Cc6634C0532925a3b8D4C9db96590c6C87",
          "royalty_percentage": 7.5,
          "royalty_recipient": "0x742d35Cc6634C0532925a3b8D4C9db96590c6C87",
          "transaction_hash": "0x1234567890abcdef...",
          "block_number": 18500000,
          "created_at": "2024-01-15T10:30:00Z"
        }
        ```
      
      api_response:
        ```json
        {
          "success": true,
          "data": {
            "transaction_hash": "0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef",
            "nft_id": "1",
            "ip_id": "0xabcdef1234567890abcdef1234567890abcdef12",
            "metadata_uri": "ipfs://QmMetadataHash...",
            "block_number": 18500000
          }
        }
        ```
    
    step_5:
      description: "Frontend success handling"
      ui_updates:
        - "Hide loading state"
        - "Show success message"
        - "Display transaction details"
        - "Provide navigation options"
      
      success_display:
        - "Transaction hash with explorer link"
        - "NFT ID and IP ID"
        - "Metadata preview"
        - "Actions: 'Create Another', 'View Portfolio'"

error_handling_integration:
  frontend_errors:
    - "Display user-friendly error messages"
    - "Provide retry mechanisms"
    - "Show suggested actions"
    - "Log errors for debugging"
  
  backend_errors:
    - "Return structured error responses"
    - "Implement retry logic for transient failures"
    - "Log detailed error information"
    - "Monitor error rates and patterns"
  
  transaction_errors:
    - "Handle gas estimation failures"
    - "Manage transaction timeouts"
    - "Process revert reasons"
    - "Implement transaction replacement"